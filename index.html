<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–µ–π—Å—ã Play2Go</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary-bg: #1a2a6c;
            --secondary-bg: #2c3e50;
            --card-bg: #34495e;
            --text-color: #ecf0f1;
            --accent-color: #f1c40f;
            --border-color: #7f8c8d;
            --success: #2ecc71;
            --warning: #f39c12;
            --error: #e74c3c;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-bg), var(--secondary-bg));
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: rgba(44, 62, 80, 0.8);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        h1 {
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .info {
            background-color: rgba(52, 73, 94, 0.7);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .info p {
            margin: 5px 0;
        }
        .case-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .case-item {
            background: linear-gradient(135deg, var(--card-bg), #2c3e50);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .case-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #3d566e, #34495e);
        }
        .case-item.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .case-item.unavailable:hover {
            transform: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .case-emoji {
            font-size: 2.5em;
            display: block;
            margin-bottom: 10px;
        }
        .case-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #bdc3c7;
        }
        .case-cost {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--error);
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .case-win {
            font-size: 0.8em;
            color: #95a5a6;
        }
        .hidden { display: none; }
        #resultModal {
            position: fixed; z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: linear-gradient(135deg, #2c3e50, #1a2a6c);
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 15px;
            right: 20px;
        }
        .close:hover { color: #fff; }
        #loadingSpinner {
            border: 5px solid #3498db;
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .notification {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            position: relative;
        }
        .notification.success { background-color: var(--success); color: white; }
        .notification.error { background-color: var(--error); color: white; }
        .notification.info { background-color: #3498db; color: white; }
        #notifications { position: fixed; top: 20px; right: 20px; z-index: 1001; width: 300px; }
        button {
            background: linear-gradient(to right, #27ae60, var(--success));
            border: none;
            color: white;
            padding: 12px 24px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 2px;
            cursor: pointer;
            border-radius: 50px;
            width: 100%;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        button:hover {
            background: linear-gradient(to right, #219653, #27ae60);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }
        button:disabled {
            background: linear-gradient(to right, #95a5a6, #7f8c8d);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .balance-highlight {
            color: var(--accent-color);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÆ –ö–µ–π—Å—ã –£–¥–∞—á–∏</h1>
        <div id="userInfo" class="info">
            <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> <span id="displayUsername">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
            <p><strong>–ó–≤—ë–∑–¥:</strong> <span id="displayStars" class="balance-highlight">–ó–∞–≥—Ä—É–∑–∫–∞...</span> ‚≠ê</p>
            <p><small>ID: <span id="displayUserId">-</span></small></p>
        </div>

        <div id="notifications"></div>

        <div id="casesSection">
            <h2 style="text-align:center; color: #3498db;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–µ–π—Å:</h2>
            <div id="caseGrid" class="case-grid">
                <!-- –ö–µ–π—Å—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å—é–¥–∞ -->
                <p style="grid-column: 1 / -1; text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–µ–π—Å–æ–≤...</p>
            </div>
        </div>
    </div>

    <div id="resultModal" class="hidden">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modalBody">
                <div id="loadingSpinner"></div>
                <p>üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–µ–π—Å–∞...</p>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide();

        // --- –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ URL ---
        const urlParams = new URLSearchParams(window.location.search);
        const userId = parseInt(urlParams.get('user_id'));
        const usernameFromUrl = urlParams.get('username');
        let starsFromUrl = parseFloat(urlParams.get('stars'));

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let userData = {
            user_id: userId,
            username: usernameFromUrl || (userId ? `user_${userId}` : '–ì–æ—Å—Ç—å'),
            stars: isNaN(starsFromUrl) ? 0 : starsFromUrl
        };

        if (!userData.user_id) {
            alert('–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ URL.');
            showNotification('–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.', 'error');
            // tg.close(); // –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–Ω—ã
        } else {
            document.getElementById('displayUserId').textContent = userData.user_id;
            document.getElementById('displayUsername').textContent = userData.username;
            document.getElementById('displayStars').textContent = userData.stars.toFixed(2);
            console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ URL:`, userData);
            loadUserInfo(); // –ü–æ–ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞
            loadCases();    // –ó–∞–≥—Ä—É–∑–∏–º –∫–µ–π—Å—ã
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API ---
        // –í–ê–ñ–ù–û: –£–ö–ê–ñ–ò–¢–ï –ü–†–ê–í–ò–õ–¨–ù–´–ô –ê–î–†–ï–° –í–ê–®–ï–ì–û API
        const API_BASE_URL = 'https://tgbot.play2go.cloud/api'; // <-- –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω API

        async function apiCall(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                },
            };
            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers,
                }
            };

            try {
                // –î–ª—è GET –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç–µ–ª–æ –Ω–µ –Ω—É–∂–Ω–æ
                if (finalOptions.method && finalOptions.method.toUpperCase() === 'GET') {
                     delete finalOptions.body;
                }

                console.log(`[API CALL] ${url}`, finalOptions);
                const response = await fetch(url, finalOptions);

                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || errorMessage;
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON, –µ—Å–ª–∏ —Ç–µ–ª–æ –Ω–µ JSON
                        errorMessage = await response.text() || errorMessage;
                    }
                    console.error(`[API ERROR] ${url}`, errorMessage);
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log(`[API SUCCESS] ${url}`, data);
                return data;
            } catch (error) {
                console.error(`[API FAILED] ${url}`, error);
                showNotification(`–û—à–∏–±–∫–∞ API: ${error.message}`, 'error');
                throw error; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ
            }
        }


        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ---
        async function loadUserInfo() {
             try {
                 const data = await apiCall(`/user/${userData.user_id}`);
                 if (data.success) {
                     userData.username = data.username || userData.username;
                     userData.stars = data.stars;
                     document.getElementById('displayUsername').textContent = userData.username;
                     document.getElementById('displayStars').textContent = userData.stars.toFixed(2);
                     console.log("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞:", data);
                 } else {
                     console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞:", data.error);
                     // –û—Å—Ç–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                 }
             } catch (error) {
                  console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:", error);
                  // showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
             }
        }

        async function loadCases() {
            try {
                const data = await apiCall('/cases');
                if (data.success) {
                    renderCases(data.cases);
                } else {
                    throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–µ–π—Å–æ–≤');
                }
            } catch (error) {
                document.getElementById('caseGrid').innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--error);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–µ–π—Å–æ–≤: ${error.message}</p>`;
                showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–µ–π—Å–æ–≤: ${error.message}`, 'error');
            }
        }

        function renderCases(casesList) {
            const gridContainer = document.getElementById('caseGrid');
            gridContainer.innerHTML = '';

            if (!casesList || casesList.length === 0) {
                gridContainer.innerHTML = `<p style="grid-column: 1 / -1; text-align: center;">–ö–µ–π—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>`;
                return;
            }

            casesList.forEach(caseItem => {
                const caseElement = document.createElement('div');
                caseElement.className = 'case-item';
                caseElement.dataset.caseId = caseItem.id;

                const canAfford = userData.stars >= caseItem.cost;
                if (!canAfford) {
                    caseElement.classList.add('unavailable');
                    caseElement.title = `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥. –ù—É–∂–Ω–æ ${caseItem.cost}`;
                }

                caseElement.innerHTML = `
                    <span class="case-cost">${caseItem.cost} ‚≠ê</span>
                    <span class="case-emoji">${caseItem.emoji}</span>
                    <div class="case-name">${caseItem.name}</div>
                    ${
                        caseItem.id === 5 ?
                        '<div class="case-win">üéÅ –°–ª—É—á–∞–π–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫</div>' :
                        `<div class="case-win">üí∞ –ó–≤—ë–∑–¥—ã</div>`
                    }
                `;

                if (canAfford) {
                    caseElement.addEventListener('click', () => openCase(caseItem));
                }

                gridContainer.appendChild(caseElement);
            });
        }

        // --- –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞ ---
        async function openCase(caseItem) {
            console.log(`–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å: ${caseItem.name}`);
            const modal = document.getElementById('resultModal');
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div id="loadingSpinner"></div>
                <p>üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–µ–π—Å–∞ "${caseItem.emoji} ${caseItem.name}"...</p>
            `;
            modal.classList.remove('hidden');

            document.querySelector('.close').onclick = function() {
                modal.classList.add('hidden');
            }
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.classList.add('hidden');
                }
            }

            try {
                const response = await apiCall('/open_case', {
                    method: 'POST',
                    body: JSON.stringify({ user_id: userData.user_id, case_id: caseItem.id })
                });

                if (response.success) {
                     // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –∑–≤—ë–∑–¥
                     if (response.new_balance !== undefined) {
                         userData.stars = response.new_balance;
                         document.getElementById('displayStars').textContent = userData.stars.toFixed(2);
                     }

                     let resultHTML = `<h2>${response.message}</h2>`;
                     if (response.result.type === 'stars') {
                         resultHTML += `
                             <p style="font-size: 3em; color: var(--accent-color);">‚≠ê ${response.result.amount}</p>
                             <p>üéä –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –∑–≤—ë–∑–¥!</p>
                         `;
                         showNotification(`–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${response.result.amount} –∑–≤—ë–∑–¥!`, 'success');
                     } else if (response.result.type === 'gift' && response.result.gift) {
                         const gift = response.result.gift;
                         resultHTML += `
                             <p style="font-size: 3em;">${gift.emoji}</p>
                             <p><strong>${gift.name}</strong></p>
                             <p>(${gift.value} ‚≠ê)</p>
                             <p>üéÅ –ü–æ–¥–∞—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –±–æ—Ç–∞!</p>
                         `;
                         showNotification(`–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${gift.emoji} ${gift.name}!`, 'success');
                     } else {
                         resultHTML += `<p>‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</p>`;
                     }
                     resultHTML += `<button onclick="document.getElementById('resultModal').classList.add('hidden');">OK</button>`;
                     modalBody.innerHTML = resultHTML;

                     // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–µ–π—Å–æ–≤, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
                     loadCases();
                     // –ò –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                     loadUserInfo();

                } else {
                    throw new Error(response.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞');
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–µ–π—Å–∞:", error);
                modalBody.innerHTML = `
                    <h2 style="color: var(--error);">‚ùå –û—à–∏–±–∫–∞</h2>
                    <p>${error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.'}</p>
                    <button onclick="document.getElementById('resultModal').classList.add('hidden');">–ó–∞–∫—Ä—ã—Ç—å</button>
                `;
                showNotification(`–û—à–∏–±–∫–∞: ${error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.'}`, 'error');
            }
        }

        // --- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ---
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            container.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode === container) {
                    notification.remove();
                }
            }, 5000);
        }

    </script>
</body>
</html>
